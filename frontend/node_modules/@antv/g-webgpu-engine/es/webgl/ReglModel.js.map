{"version":3,"file":"ReglModel.js","names":["gl","extractUniforms","blendEquationMap","blendFuncMap","cullFaceMap","depthFuncMap","primitiveMap","stencilFuncMap","stencilOpMap","ReglModel","reGl","options","drawCommand","uniforms","vs","fs","defines","attributes","primitive","count","elements","depth","blend","stencil","cull","instances","scissor","viewport","reglUniforms","Object","keys","forEach","uniformName","prop","reglAttributes","name","get","defineStmts","generateDefines","drawParams","frag","vert","undefined","TRIANGLES","initDepthDrawParams","initBlendDrawParams","initStencilDrawParams","initCullDrawParams","reglDrawProps","type","Array","isArray","BYTES_PER_ELEMENT","enable","mask","func","LESS","range","equation","color","srcRGB","SRC_ALPHA","srcAlpha","dstRGB","ONE_MINUS_SRC_ALPHA","dstAlpha","rgb","FUNC_ADD","alpha","cmp","ALWAYS","ref","opFront","fail","KEEP","zfail","zpass","opBack","face","BACK","map","Number","join"],"sources":["../../src/webgl/ReglModel.ts"],"sourcesContent":["import {\n  gl,\n} from '@antv/g-webgpu-core';\nimport type {\n  IModel,\n  IModelDrawOptions,\n  IModelInitializationOptions,\n  IUniform,\n} from '@antv/g-webgpu-core';\nimport regl from 'regl';\nimport { extractUniforms } from '../utils/uniform';\nimport {\n  blendEquationMap,\n  blendFuncMap,\n  cullFaceMap,\n  depthFuncMap,\n  primitiveMap,\n  stencilFuncMap,\n  stencilOpMap,\n} from './constants';\nimport ReglAttribute from './ReglAttribute';\nimport ReglElements from './ReglElements';\nimport ReglFramebuffer from './ReglFramebuffer';\nimport ReglTexture2D from './ReglTexture2D';\n\n/**\n * adaptor for regl.DrawCommand\n */\nexport default class ReglModel implements IModel {\n  private reGl: regl.Regl;\n  private drawCommand: regl.DrawCommand;\n  private uniforms: {\n    [key: string]: IUniform;\n  } = {};\n\n  constructor(reGl: regl.Regl, options: IModelInitializationOptions) {\n    this.reGl = reGl;\n    const {\n      vs,\n      fs,\n      defines,\n      attributes,\n      uniforms,\n      primitive,\n      count,\n      elements,\n      depth,\n      blend,\n      stencil,\n      cull,\n      instances,\n      scissor,\n      // @ts-ignore\n      viewport,\n    } = options;\n    const reglUniforms: { [key: string]: IUniform } = {};\n    if (uniforms) {\n      this.uniforms = extractUniforms(uniforms);\n      Object.keys(uniforms).forEach((uniformName) => {\n        // use regl prop API\n        // @ts-ignore\n        reglUniforms[uniformName] = reGl.prop(uniformName);\n      });\n    }\n\n    const reglAttributes: { [key: string]: regl.Attribute } = {};\n    Object.keys(attributes).forEach((name: string) => {\n      reglAttributes[name] = (attributes[name] as ReglAttribute).get();\n    });\n\n    const defineStmts = (defines && this.generateDefines(defines)) || '';\n    const drawParams: regl.DrawConfig = {\n      attributes: reglAttributes,\n      frag: `#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n${defineStmts}\n${fs}`,\n      uniforms: reglUniforms,\n      vert: `\n${defineStmts}\n${vs}`,\n      primitive:\n        primitiveMap[primitive === undefined ? gl.TRIANGLES : primitive],\n    };\n    if (instances) {\n      drawParams.instances = instances;\n    }\n\n    // elements 中可能包含 count，此时不应传入\n    if (count) {\n      drawParams.count = count;\n    }\n\n    if (elements) {\n      drawParams.elements = (elements as ReglElements).get();\n    }\n\n    if (scissor) {\n      drawParams.scissor = scissor;\n    }\n\n    if (viewport) {\n      drawParams.viewport = viewport;\n    }\n\n    this.initDepthDrawParams({ depth }, drawParams);\n    this.initBlendDrawParams({ blend }, drawParams);\n    this.initStencilDrawParams({ stencil }, drawParams);\n    this.initCullDrawParams({ cull }, drawParams);\n\n    this.drawCommand = reGl(drawParams);\n  }\n\n  public addUniforms(uniforms: { [key: string]: IUniform }) {\n    this.uniforms = {\n      ...this.uniforms,\n      ...extractUniforms(uniforms),\n    };\n  }\n\n  public draw(options: IModelDrawOptions) {\n    const uniforms: {\n      [key: string]: IUniform;\n    } = {\n      ...this.uniforms,\n      ...extractUniforms(options.uniforms || {}),\n    };\n\n    const reglDrawProps: {\n      [key: string]:\n        | regl.Framebuffer\n        | regl.Texture2D\n        | number\n        | number[]\n        | boolean;\n    } = {};\n\n    Object.keys(uniforms).forEach((uniformName: string) => {\n      const type = typeof uniforms[uniformName];\n      if (\n        type === 'boolean' ||\n        type === 'number' ||\n        Array.isArray(uniforms[uniformName]) ||\n        // @ts-ignore\n        uniforms[uniformName].BYTES_PER_ELEMENT\n      ) {\n        reglDrawProps[uniformName] = uniforms[uniformName] as\n          | number\n          | number[]\n          | boolean;\n      } else if (type === 'string') {\n        // TODO: image url\n      } else {\n        reglDrawProps[uniformName] = (uniforms[uniformName] as\n          | ReglFramebuffer\n          | ReglTexture2D).get();\n      }\n    });\n    this.drawCommand(reglDrawProps);\n  }\n\n  public destroy() {\n    // don't need do anything since we will call `rendererService.cleanup()`\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#depth-buffer\n   */\n  private initDepthDrawParams(\n    { depth }: Pick<IModelInitializationOptions, 'depth'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (depth) {\n      drawParams.depth = {\n        enable: depth.enable === undefined ? true : !!depth.enable,\n        mask: depth.mask === undefined ? true : !!depth.mask,\n        func: depthFuncMap[depth.func || gl.LESS],\n        range: depth.range || [0, 1],\n      };\n    }\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#blending\n   */\n  private initBlendDrawParams(\n    { blend }: Pick<IModelInitializationOptions, 'blend'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (blend) {\n      const { enable, func, equation, color = [0, 0, 0, 0] } = blend;\n      // @ts-ignore\n      drawParams.blend = {\n        enable: !!enable,\n        func: {\n          srcRGB: blendFuncMap[(func && func.srcRGB) || gl.SRC_ALPHA],\n          srcAlpha: blendFuncMap[(func && func.srcAlpha) || gl.SRC_ALPHA],\n          dstRGB: blendFuncMap[(func && func.dstRGB) || gl.ONE_MINUS_SRC_ALPHA],\n          dstAlpha:\n            blendFuncMap[(func && func.dstAlpha) || gl.ONE_MINUS_SRC_ALPHA],\n        },\n        equation: {\n          rgb: blendEquationMap[(equation && equation.rgb) || gl.FUNC_ADD],\n          alpha: blendEquationMap[(equation && equation.alpha) || gl.FUNC_ADD],\n        },\n        color,\n      };\n    }\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#stencil\n   */\n  private initStencilDrawParams(\n    { stencil }: Pick<IModelInitializationOptions, 'stencil'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (stencil) {\n      const {\n        enable,\n        mask = -1,\n        func = {\n          cmp: gl.ALWAYS,\n          ref: 0,\n          mask: -1,\n        },\n        opFront = {\n          fail: gl.KEEP,\n          zfail: gl.KEEP,\n          zpass: gl.KEEP,\n        },\n        opBack = {\n          fail: gl.KEEP,\n          zfail: gl.KEEP,\n          zpass: gl.KEEP,\n        },\n      } = stencil;\n      drawParams.stencil = {\n        enable: !!enable,\n        mask,\n        func: {\n          ...func,\n          cmp: stencilFuncMap[func.cmp],\n        },\n        opFront: {\n          fail: stencilOpMap[opFront.fail],\n          zfail: stencilOpMap[opFront.zfail],\n          zpass: stencilOpMap[opFront.zpass],\n        },\n        opBack: {\n          fail: stencilOpMap[opBack.fail],\n          zfail: stencilOpMap[opBack.zfail],\n          zpass: stencilOpMap[opBack.zpass],\n        },\n      };\n    }\n  }\n\n  /**\n   * @see https://github.com/regl-project/regl/blob/gh-pages/API.md#culling\n   */\n  private initCullDrawParams(\n    { cull }: Pick<IModelInitializationOptions, 'cull'>,\n    drawParams: regl.DrawConfig,\n  ) {\n    if (cull) {\n      const { enable, face = gl.BACK } = cull;\n      drawParams.cull = {\n        enable: !!enable,\n        face: cullFaceMap[face],\n      };\n    }\n  }\n\n  private generateDefines(defines: Record<string, number | boolean>) {\n    return Object.keys(defines)\n      .map((name) => `#define ${name} ${Number(defines[name])}`)\n      .join('\\n');\n  }\n}\n"],"mappings":"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"}